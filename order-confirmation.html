<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fatura / Konfirmimi i Porosisë | AutoBesa</title>
  <link rel="icon" href="favicon-car.svg" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="index.css">
  <style>
    .invoice { padding:40px 0; }
    .invoice-card{ background:#fff; padding:20px; border-radius:10px; border:1px solid #eee; }
    .invoice-head{ display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .invoice-items{ margin-top:18px; }
    .inv-row{ display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px dashed #eee; }
    .print-actions{ display:flex; gap:8px; margin-top:18px; }
    @media (max-width:768px){ .invoice-head{ flex-direction:column; align-items:flex-start; } }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark sticky-top" role="navigation" aria-label="Main navigation">
    <div class="container-fluid px-4">
      <!-- Logo & Brand -->
      <a class="navbar-brand d-flex align-items-center gap-2" href="index.html">
        <img src="logo.png" alt="AutoBesa" class="nav-logo">
        <span class="d-none d-md-inline">AutoBesa</span>
      </a>

      <!-- Mobile Toggle Button -->
      <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <!-- Navigation Links -->
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto nav gap-1">
          <li class="nav-item">
            <a class="nav-link" href="index.html" aria-label="Ballina">
              <i class="bi bi-house-door"></i> Ballina
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="rethnesh.html" aria-label="Rreth Nesh">
              <i class="bi bi-info-circle"></i> Rreth Nesh
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="makinat.html" aria-label="Makinat">
              <i class="bi bi-car-front"></i> Makinat
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="contact.html" aria-label="Kontakt">
              <i class="bi bi-envelope"></i> Kontakt
            </a>
          </li>
        </ul>
      </div>

      <!-- Icon Buttons -->
      <div class="nav-icons d-flex align-items-center gap-2 ms-3">
        <!-- Search Button -->
        <button class="icon-btn btn-search" aria-label="Kërko" title="Kërko" data-bs-toggle="collapse" data-bs-target="#navSearch">
          <i class="bi bi-search"></i>
        </button>

        <!-- Cart Button -->
        <button class="icon-btn btn-cart" aria-label="Shporta" title="Shporta">
          <i class="bi bi-cart"></i>
          <span class="icon-bubble cart-count">0</span>
        </button>
      </div>
    </div>

    <!-- Search Dropdown -->
    <div class="collapse" id="navSearch">
      <div class="container-fluid px-4 py-3 bg-dark border-top border-secondary">
        <input id="navSearchInput" class="form-control" type="search" placeholder="Kërko marka, model...">
      </div>
    </div>
  </nav>

  <main class="invoice container">
    <div class="invoice-card" id="invoiceRoot">
      <div id="invoiceContent">Loading porosi...</div>
      <div class="print-actions">
        <button id="printBtn" class="btn btn-primary"><i class="bi bi-printer"></i> Printo / Ruaj PDF</button>
        <a id="downloadJson" class="btn btn-ghost">Shkarko JSON</a>
        <a href="index.html" class="btn btn-outline-autobesa">Kthehu te Ballina</a>
      </div>
    </div>
  </main>

  <script>
    const ORDERS_KEY = 'autobesa_orders_v1';
    function formatCurrency(n){ return '€' + (n/100).toLocaleString('en-GB', {minimumFractionDigits:2, maximumFractionDigits:2}); }
    function loadOrderFromHash(){
      const id = location.hash ? location.hash.substring(1) : null;
      const orders = JSON.parse(localStorage.getItem(ORDERS_KEY) || '[]');
      if(!id){ document.getElementById('invoiceContent').innerHTML = '<div class="alert alert-info">Nuk u gjet nr. porosisë në URL.</div>'; return; }
      const order = orders.find(o=>o.id===id);
      if(!order){ document.getElementById('invoiceContent').innerHTML = `<div class=\"alert alert-danger\">Porosia me ID <strong>${id}</strong> nuk u gjet.</div>`; return; }
      renderOrder(order);
    }
    function renderOrder(order){
      const root = document.getElementById('invoiceContent');
      const itemsHtml = order.items.map(it=>{
        const qty = it.quantity || 1; const priceCents = Math.round((it.price||0) * 100);
        const lineCents = priceCents * qty;
        return `<div class=\"inv-row\"><div>${it.model} × ${qty}</div><div>${formatCurrency(lineCents)}</div></div>`;
      }).join('');
      const subtotal = order.totals ? order.totals.subtotalCents : 0;
      const taxes = order.totals ? order.totals.taxCents : 0;
      const shipping = order.totals ? order.totals.shippingCents : 0;
      const total = order.totals ? order.totals.totalCents : 0;
      root.innerHTML = `
        <div class="invoice-head">
          <div>
            <h3>AutoBesa - Fatura e Porosisë</h3>
            <div>Nr. porosisë: <strong>${order.id}</strong></div>
            <div>Krijuar: ${new Date(order.createdAt).toLocaleString()}</div>
          </div>
          <div>
            <strong>${formatCurrency(total)}</strong>
            <div class="text-muted">Totali</div>
          </div>
        </div>
        <hr />
        <div><strong>Detajet e klientit</strong>
          <div>${order.customer.fullname}</div>
          <div>${order.customer.phone} • ${order.customer.email}</div>
          <div>${order.customer.address}</div>
        </div>
        <div class="invoice-items">${itemsHtml}</div>
        <div style="margin-top:12px">
          <div class=\"inv-row\"><div>Nëntotali</div><div>${formatCurrency(subtotal)}</div></div>
          <div class=\"inv-row\"><div>TVSH (18%)</div><div>${formatCurrency(taxes)}</div></div>
          <div class=\"inv-row\"><div>Transporti</div><div>${formatCurrency(shipping)}</div></div>
          <div class=\"inv-row\" style=\"font-weight:700; font-size:1.05rem\"><div>Totali</div><div>${formatCurrency(total)}</div></div>
        </div>
      `;

      document.getElementById('printBtn').addEventListener('click', ()=>{ window.print(); });
      document.getElementById('downloadJson').href = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(order, null, 2));
      document.getElementById('downloadJson').setAttribute('download', `${order.id}.json`);
    }

    window.addEventListener('DOMContentLoaded', loadOrderFromHash);
  </script>
</body>
</html>